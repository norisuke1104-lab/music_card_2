<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音楽鑑賞カード選択ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Firebase SDK を追加 -->
    <script type="module">
        // これらのインポートは変更しないでください
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // ===== Firebase 設定（ユーザー提供のものを反映済み）=====
        const firebaseConfig = {
            apiKey: "AIzaSyCRHtsT5k0vTLs2Fcstu3UEoRN-SI11q5A",
            authDomain: "music-card-3e566.firebaseapp.com",
            projectId: "music-card-3e566",
            storageBucket: "music-card-3e566.appspot.com",
            messagingSenderId: "517460347633",
            appId: "1:517460347633:web:c022e0acaf2395e0387750",
            measurementId: "G-P5K172KNX3"
        };

        // --- これより下のコードは、通常は変更不要です ---
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.firebaseDB = db;
            window.firebaseTools = { collection, addDoc, onSnapshot, query, orderBy, serverTimestamp };
            console.log("Firebase initialized successfully!");
        } catch (error) {
            console.error("Firebaseの初期化に失敗しました。firebaseConfigが正しく設定されているか確認してください。", error);
            alert("Firebaseの初期化に失敗しました。設定を確認してください。");
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .card { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        #selection-area { position: relative; overflow: hidden; }
        #selection-area .card { position: absolute; cursor: grab; }
        #selection-area .card:active { cursor: grabbing; z-index: 10; }
        .teacher-submission-card { transition: all 0.3s; }
        .teacher-submission-card:hover { transform: scale(1.03); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <!-- ===== ログインモーダル ===== -->
    <div id="login-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center w-11/12 max-w-md">
            <h2 class="text-2xl font-bold mb-4">ようこそ！</h2>
            <p class="text-gray-600 mb-6">あなたの名前を入力してください。<br>追加したカードがこのブラウザに保存されます。</p>
            <input type="text" id="username-input" class="w-full border-2 border-gray-300 rounded-md p-3 text-lg text-center focus:border-blue-500 focus:ring-blue-500 transition" placeholder="なまえ">
            <button id="login-button" class="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors">はじめる</button>
        </div>
    </div>
    
    <!-- ===== 生徒用メイン画面 ===== -->
    <div id="student-container" class="max-w-7xl mx-auto">
        <header class="text-center mb-4">
            <div id="user-info" class="text-left text-sm mb-4"></div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">音楽鑑賞カード選択ツール</h1>
            <p class="text-gray-500 mt-2">音楽を聴いて感じたことや、聴き取ったことに合うカードを選んでみよう。</p>
        </header>
        <section class="mb-10 pt-6 border-t-2 border-gray-300">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-bold text-gray-700">選んだカード（自由に動かして配置できます）</h2>
                <div class="flex gap-2 flex-wrap justify-end">
                     <button id="submit-layout-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        <span>この配置を提出する</span>
                    </button>
                    <button id="clear-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">すべて消す</button>
                </div>
            </div>
            <div id="selection-area" class="min-h-[250px] bg-white rounded-xl shadow-inner border-2 border-dashed border-gray-300 p-4 flex flex-wrap gap-2 items-start transition-colors">
                <p id="selection-placeholder" class="text-gray-400 self-center w-full text-center absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y/2">下のカードをクリック（またはドラッグ＆ドロップ）して、ここに追加します。</p>
            </div>
        </section>
        <main id="card-banks" class="space-y-8">
            <div id="loading-state" class="text-center py-10"><p class="text-lg text-gray-600">スプレッドシートからデータを読み込んでいます...</p><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mt-4"></div></div>
        </main>
    </div>

    <!-- ===== 先生用ダッシュボード画面 ===== -->
    <div id="teacher-container" class="max-w-7xl mx-auto hidden">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">先生用ダッシュボード</h1>
            <p class="text-gray-500 mt-2">生徒から提出されたカード配置がリアルタイムで表示されます。</p>
        </header>
        <div id="submissions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <p id="submissions-placeholder" class="text-gray-500 col-span-full text-center py-10">まだ提出された作品はありません。</p>
        </div>
    </div>

    <script type="module">
        // --- DOM要素 ---
        const loginModal = document.getElementById('login-modal');
        const usernameInput = document.getElementById('username-input');
        const loginButton = document.getElementById('login-button');
        const studentContainer = document.getElementById('student-container');
        const teacherContainer = document.getElementById('teacher-container');
        const userInfo = document.getElementById('user-info');
        const submitLayoutButton = document.getElementById('submit-layout-button');
        const cardBanks = document.getElementById('card-banks');
        const selectionArea = document.getElementById('selection-area');
        const selectionPlaceholder = document.getElementById('selection-placeholder');
        const clearButton = document.getElementById('clear-button');
        const loadingState = document.getElementById('loading-state');
        const submissionsGrid = document.getElementById('submissions-grid');
        const submissionsPlaceholder = document.getElementById('submissions-placeholder');
        
        // --- 定数 ---
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbzbpGuYyEgO4v3DGtF5vfw9lFqAnqT1k35r3REw8GT_CqS3eZ5tsjETwe8cilEN3LHB/exec';
        const categoryColors = { '音色': '#3b82f6', 'リズム': '#22c55e', '速度': '#eab308', '旋律': '#ef4444', 'テクスチュア': '#a855f7', '強弱': '#f97316', '形式': '#ec4899', '構成': '#14b8a6' };
        const defaultColor = '#6b7280';
        
        let currentUser = null;
        let draggedCard = null;
        let activeCard = null, offsetX, offsetY;

        // --- 関数定義 ---

        function handleLogin() {
            currentUser = localStorage.getItem('musicCardToolUser');
            if (currentUser) {
                startStudentApp();
            } else {
                loginModal.classList.remove('hidden');
            }
        }

        function startStudentApp() {
            loginModal.classList.add('hidden');
            studentContainer.classList.remove('hidden');
            userInfo.innerHTML = `<span>こんにちは、<strong class="font-bold">${currentUser}</strong> さん</span>`;
            fetchCardData();
        }

        function getCustomCardsStorageKey() { return `customCards_${currentUser}`; }
        function loadCustomCards() { return JSON.parse(localStorage.getItem(getCustomCardsStorageKey())) || []; }
        function saveCustomCards(cards) { localStorage.setItem(getCustomCardsStorageKey(), JSON.stringify(cards)); }
        
        function addCustomCard(cardData) {
            const customCards = loadCustomCards();
            customCards.push(cardData);
            saveCustomCards(customCards);
        }

        function deleteCustomCard(cardData) {
            let customCards = loadCustomCards();
            customCards = customCards.filter(card => !(card.Text === cardData.Text && card.CardType === cardData.CardType && card.Category === cardData.Category));
            saveCustomCards(customCards);
        }

        function showTeacherView() {
            loginModal.classList.add('hidden');
            studentContainer.classList.add('hidden');
            teacherContainer.classList.remove('hidden');
            loadSubmissions();
        }

        function loadSubmissions() {
            if (!window.firebaseDB) return;
            const { collection, query, orderBy, onSnapshot } = window.firebaseTools;
            const submissionsRef = collection(window.firebaseDB, "submissions");
            const q = query(submissionsRef, orderBy("timestamp", "desc"));
            onSnapshot(q, (querySnapshot) => {
                submissionsPlaceholder.classList.toggle('hidden', !querySnapshot.empty);
                submissionsGrid.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const submission = doc.data();
                    const cardEl = document.createElement('div');
                    cardEl.className = 'teacher-submission-card bg-white p-4 rounded-lg shadow-md cursor-pointer';
                    const cardLayoutHtml = submission.layout.map(card => {
                        const color = categoryColors[card.Category] || defaultColor;
                        return `<div class="text-xs font-semibold p-1 rounded" style="background-color: ${color}20; border-left: 3px solid ${color};">${card.Text}</div>`;
                    }).join('');
                    cardEl.innerHTML = `<h3 class="font-bold text-lg">${submission.user} さん</h3><p class="text-xs text-gray-500 mb-2">${new Date(submission.timestamp?.toDate()).toLocaleString()}</p><div class="space-y-1">${cardLayoutHtml || 'カードがありません'}</div>`;
                    submissionsGrid.appendChild(cardEl);
                });
            });
        }
        
        async function fetchCardData() {
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                const csvText = await response.text();
                const cardData = parseCSV(csvText);
                if (cardData.length === 0) {
                    throw new Error('スプレッドシートからカードデータを解析できませんでした。内容を確認してください。');
                }
                renderCards(cardData);
                loadingState.classList.add('hidden');
            } catch (error) { 
                console.error('Error fetching card data:', error);
                loadingState.innerHTML = `<p class="text-red-500">カードデータの読み込みに失敗しました。URLやスプレッドシートの内容を確認してください。</p>`;
            }
        }

        function parseCSV(text) {
             const lines = text.trim().split(/\r\n|\n/);
             const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
             const cardTypeIndex = headers.indexOf('CardType');
             const categoryIndex = headers.indexOf('Category');
             const textIndex = headers.indexOf('Text');
             if (cardTypeIndex === -1 || categoryIndex === -1 || textIndex === -1) { return []; }
             return lines.slice(1).map(line => {
                const parts = line.split(',');
                const CardType = (parts[cardTypeIndex] || '').trim().replace(/"/g, '');
                const Category = (parts[categoryIndex] || '').trim().replace(/"/g, '');
                const Text = (parts[textIndex] || '').trim().replace(/"/g, '');
                return { CardType, Category, Text };
             }).filter(card => card && card.Text && card.CardType);
        }
        
        function renderCards(data) {
            const customCards = loadCustomCards();
            const allData = [...data, ...customCards.map(c => ({...c, isCustom: true}))];

            const cardsByType = allData.reduce((acc, card) => {
                const type = card.CardType || 'その他';
                if (!acc[type]) acc[type] = [];
                acc[type].push(card);
                return acc;
            }, {});
            cardBanks.innerHTML = '';
            
            const kanjiSection = document.createElement('section');
            kanjiSection.className = 'bg-white p-4 md:p-6 rounded-xl shadow-md';
            kanjiSection.innerHTML = `
                <h3 class="text-xl font-bold mb-2">感じカード</h3>
                <div class="flex gap-2 items-center my-3">
                    <input type="text" placeholder="自由な言葉を追加..." class="custom-card-input flex-grow border-gray-300 rounded-md shadow-sm text-sm p-1.5" data-category="" data-type="感じ">
                    <button class="add-custom-card-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1.5 px-3 rounded-md text-sm" data-category="" data-type="感じ">追加</button>
                </div>
            `;
            const kanjiContainer = document.createElement('div');
            kanjiContainer.className = 'flex flex-wrap gap-2';
            kanjiContainer.id = 'container-感じ';
            (cardsByType['感じ'] || []).forEach(card => kanjiContainer.appendChild(createCard(card, card.isCustom)));
            kanjiSection.appendChild(kanjiContainer);
            cardBanks.appendChild(kanjiSection);

            if (cardsByType['特徴']) {
                const tokuchoSection = document.createElement('section');
                tokuchoSection.className = 'bg-white p-4 md:p-6 rounded-xl shadow-md';
                tokuchoSection.innerHTML = `<h3 class="text-xl font-bold mb-2">特徴カード</h3>`;
                const categoryGrid = document.createElement('div');
                categoryGrid.className = 'space-y-4 mt-4';

                const cardsByCategory = cardsByType['特徴'].reduce((acc, card) => {
                    const category = card.Category || 'その他';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(card);
                    return acc;
                }, {});

                Object.keys(categoryColors).forEach(category => {
                    const categorySubSection = document.createElement('div');
                    const color = categoryColors[category] || defaultColor;
                    categorySubSection.innerHTML = `
                        <h4 class="text-md font-bold pb-1" style="border-bottom: 3px solid ${color};">${category}</h4>
                        <div class="flex gap-2 items-center my-3">
                            <input type="text" placeholder="自由な言葉を追加..." class="custom-card-input flex-grow border-gray-300 rounded-md shadow-sm text-sm p-1.5" data-category="${category}" data-type="特徴">
                            <button class="add-custom-card-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-1.5 px-3 rounded-md text-sm" data-category="${category}" data-type="特徴">追加</button>
                        </div>`;
                    const container = document.createElement('div');
                    container.className = 'flex flex-wrap gap-2 mt-2';
                    container.id = `container-${category}`;
                    (cardsByCategory[category] || []).forEach(card => container.appendChild(createCard(card, card.isCustom)));
                    categorySubSection.appendChild(container);
                    categoryGrid.appendChild(categorySubSection);
                });
                tokuchoSection.appendChild(categoryGrid);
                cardBanks.appendChild(tokuchoSection);
            }
        }
        
        function createCard(cardData, isCustom = false) {
            const card = document.createElement('div');
            const bgColor = isCustom ? 'bg-gray-100' : 'bg-white';
            card.className = `card relative flex-shrink-0 w-16 h-20 ${bgColor} rounded-md shadow-md flex flex-col justify-between text-center font-semibold text-gray-700 select-none overflow-hidden text-xs`;
            
            const deleteButton = isCustom ? `<button class="delete-custom-card absolute top-0 right-0.5 text-lg leading-none text-red-400 hover:text-red-600 font-bold">&times;</button>` : '';
            card.innerHTML = `${deleteButton}<div class="p-1 flex-grow flex items-center justify-center">${cardData.Text}</div>`;

            if (cardData.Category) {
                const color = categoryColors[cardData.Category] || defaultColor;
                const footer = document.createElement('div');
                footer.className = 'px-1 py-0.5 text-[9px] text-white font-bold';
                footer.style.backgroundColor = color;
                footer.textContent = cardData.Category;
                card.appendChild(footer);
            }
            card.draggable = true;
            Object.assign(card.dataset, cardData);
            if(isCustom) card.dataset.isCustom = 'true';
            return card;
        }

        function addCardToSelection(originalCard, dropEvent) {
            const newCard = originalCard.cloneNode(true);
            newCard.style.position = 'absolute';
            const customDeleteBtn = newCard.querySelector('.delete-custom-card');
            if(customDeleteBtn) customDeleteBtn.remove();

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'absolute top-0 right-0.5 text-lg leading-none text-red-400 hover:text-red-600 font-bold bg-white bg-opacity-50 rounded-full w-4 h-4 flex items-center justify-center';
            deleteBtn.onclick = (e) => { e.stopPropagation(); newCard.remove(); updatePlaceholder(); };
            newCard.appendChild(deleteBtn);

            selectionArea.appendChild(newCard);
            updatePlaceholder();

            if (dropEvent) {
                const rect = selectionArea.getBoundingClientRect();
                newCard.style.left = `${dropEvent.clientX - rect.left - (newCard.offsetWidth / 2)}px`;
                newCard.style.top = `${dropEvent.clientY - rect.top - (newCard.offsetHeight / 2)}px`;
            } else {
                const gap = 10;
                const existingCards = selectionArea.querySelectorAll('.card').length - 1;
                const containerWidth = selectionArea.clientWidth;
                const cardWidthWithGap = (newCard.offsetWidth || 64) + gap;
                const cardsPerRow = Math.max(1, Math.floor((containerWidth - gap) / cardWidthWithGap));
                const col = existingCards % cardsPerRow;
                const row = Math.floor(existingCards / cardsPerRow);
                newCard.style.left = `${gap + col * cardWidthWithGap}px`;
                newCard.style.top = `${gap + row * ( (newCard.offsetHeight || 80) + gap)}px`;
            }
        }

        function updatePlaceholder() { 
            selectionPlaceholder.classList.toggle('hidden', !!selectionArea.querySelector('.card'));
        }

        function onMouseMove(e) {
            if (!activeCard) return;
            const rect = selectionArea.getBoundingClientRect();
            activeCard.style.left = `${e.clientX - rect.left - offsetX}px`;
            activeCard.style.top = `${e.clientY - rect.top - offsetY}px`;
        }

        function onMouseUp() { 
            document.removeEventListener('mousemove', onMouseMove); 
            document.removeEventListener('mouseup', onMouseUp); 
            activeCard = null; 
        }

        // --- イベントリスナー ---
        document.addEventListener('DOMContentLoaded', handleLogin);
        
        loginButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = username;
                localStorage.setItem('musicCardToolUser', currentUser);
                startStudentApp();
            } else {
                alert('名前を入力してください。');
            }
        });

        clearButton.addEventListener('click', () => { 
            selectionArea.innerHTML = ''; 
            updatePlaceholder(); 
        });

        submitLayoutButton.addEventListener('click', async () => {
            if (!window.firebaseDB) { alert("データベースに接続できません。設定を確認してください。"); return; }
            const cards = selectionArea.querySelectorAll('.card');
            if (cards.length === 0) { alert('提出するカードがありません。'); return; }
            if (!confirm('この配置を提出しますか？')) return;
            const layoutData = Array.from(cards).map(card => ({
                Text: card.dataset.text || '', 
                CardType: card.dataset.type || '', 
                Category: card.dataset.category || '',
                left: card.style.left, 
                top: card.style.top
            }));
            try {
                const { collection, addDoc, serverTimestamp } = window.firebaseTools;
                await addDoc(collection(window.firebaseDB, "submissions"), {
                    user: currentUser, 
                    layout: layoutData, 
                    timestamp: serverTimestamp()
                });
                alert('提出しました！');
                selectionArea.innerHTML = '';
                updatePlaceholder();
            } catch (error) {
                console.error("提出中にエラーが発生しました: ", error);
                alert("提出に失敗しました。");
            }
        });
        
        cardBanks.addEventListener('click', e => {
            const target = e.target;
            if (target.classList.contains('add-custom-card-button')) {
                const type = target.dataset.type;
                const category = target.dataset.category;
                const input = target.previousElementSibling;
                const inputValue = input.value.trim();
                if (inputValue) {
                    const cardData = { Text: inputValue, CardType: type, Category: category };
                    const newCard = createCard(cardData, true);
                    const containerId = type === '感じ' ? 'container-感じ' : `container-${category}`;
                    document.getElementById(containerId).appendChild(newCard);
                    addCustomCard(cardData);
                    input.value = '';
                }
            } else if (target.classList.contains('delete-custom-card')) {
                const cardElement = target.closest('.card');
                const cardData = { Text: cardElement.dataset.text, CardType: cardElement.dataset.type, Category: cardElement.dataset.category };
                deleteCustomCard(cardData);
                cardElement.remove();
            } else if (e.target.closest('.card:not(.delete-custom-card)')) {
                 addCardToSelection(e.target.closest('.card'));
            }
        });

        cardBanks.addEventListener('keydown', e => { 
            if (e.key === 'Enter' && e.target.classList.contains('custom-card-input')) { 
                e.target.nextElementSibling.click(); 
            } 
        });

        // 修正: ドラッグ開始のイベントリスナーをcardBanksに限定
        cardBanks.addEventListener('dragstart', e => { 
            if (e.target.closest('.card')) { 
                draggedCard = e.target.closest('.card'); 
            } 
        });
        document.addEventListener('dragend', () => {
            draggedCard = null;
        });
        selectionArea.addEventListener('dragover', e => e.preventDefault());
        selectionArea.addEventListener('drop', e => { e.preventDefault(); if (draggedCard) addCardToSelection(draggedCard, e); });
        
        selectionArea.addEventListener('mousedown', e => {
            if (e.target.tagName === 'BUTTON') return;
            activeCard = e.target.closest('.card'); 
            if (!activeCard) return;

            // 修正: ブラウザのデフォルトのドラッグ動作を抑制
            e.preventDefault();

            offsetX = e.clientX - activeCard.getBoundingClientRect().left; 
            offsetY = e.clientY - activeCard.getBoundingClientRect().top;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp, { once: true }); // 修正: mouseupイベントが一度だけ実行されるように
        });
    </script>
</body>
</html>

